<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-09-19 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20140919" />
    <meta http-equiv="Content-Language" content="en" />
    <title>MaPSeq - </title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Massively Parallel Sequencing</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-09-19
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.5.6-SNAPSHOT
                      </li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li>
  
                          <a href="../index.html" title="Home">
          <i class="none"></i>
        Home</a>
            </li>
                
      <li>
  
                          <a href="../download.html" title="Download">
          <i class="none"></i>
        Download</a>
            </li>
                              <li class="nav-header">Documentation</li>
                              
      <li>
  
                          <a href="../overview.html" title="Overview">
          <i class="none"></i>
        Overview</a>
            </li>
                                                                                                                                                                                                    
      <li>
  
                          <a href="../manual/index.html" title="Manual">
          <i class="icon-chevron-down"></i>
        Manual</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="../manual/building.html" title="Building">
          <i class="none"></i>
        Building</a>
            </li>
                    
      <li>
  
                          <a href="../manual/modules.html" title="Modules">
          <i class="none"></i>
        Modules</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><i class="none"></i>Workflows</a>
          </li>
                    
      <li>
  
                          <a href="../manual/pipelines.html" title="Pipelines">
          <i class="none"></i>
        Pipelines</a>
            </li>
                    
      <li>
  
                          <a href="../manual/pipeline-archetype.html" title="Pipeline Archetype">
          <i class="none"></i>
        Pipeline Archetype</a>
            </li>
                    
      <li>
  
                          <a href="../manual/commands.html" title="Commands">
          <i class="none"></i>
        Commands</a>
            </li>
                    
      <li>
  
                          <a href="../manual/reporting.html" title="Reporting">
          <i class="none"></i>
        Reporting</a>
            </li>
                    
      <li>
  
                          <a href="../manual/ws-clients.html" title="Web Service clients">
          <i class="none"></i>
        Web Service clients</a>
            </li>
              </ul>
        </li>
                                                            
      <li>
  
                          <a href="../migration/index.html" title="Migration">
          <i class="icon-chevron-down"></i>
        Migration</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="../migration/04to05.html" title="v0.4 to v0.5">
          <i class="none"></i>
        v0.4 to v0.5</a>
            </li>
              </ul>
        </li>
                              <li class="nav-header">Pipelines</li>
                              
      <li>
  
                          <a href="../casava.html" title="CASAVA">
          <i class="none"></i>
        CASAVA</a>
            </li>
                
      <li>
  
                          <a href="../rnaseq.html" title="RNASeq">
          <i class="none"></i>
        RNASeq</a>
            </li>
                
      <li>
  
                          <a href="../ncgenes.html" title="NCGenes">
          <i class="none"></i>
        NCGenes</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                
      <li>
  
                          <a href="../project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                          
      <li>
  
                          <a href="../project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            
  
    <div class="section">
<h2>Workflows<a name="Workflows"></a></h2>
      
<p>MaPSeq uses <a class="externalLink" href="http://research.cs.wisc.edu/htcondor/">HTCondor</a> as a
      meta-scheduler.  HTCondor has two types of jobs: simple &amp;
      dagman.  Simple jobs just execute one task whereas DAGMan jobs
      are Directed Acyclic Graph Managed (DAGMan) jobs.  MaPSeq only
      uses the later job type.</p>
      
<p>To construct a Directed Acyclic Graph, MaPSeq leverages a
      graphing library call <a class="externalLink" href="http://jgrapht.org/">JGraphT</a>.
      This library allows for an assortment of Java typed graphs
      (directed/undirected, cyclic/acyclic, weighted/unweighted).  For
      the purposes of high throughput sequencing, MaPSeq is only
      concerned with directed acyclic graphs.  Using the CondorJob
      &amp; CondorJobEdge classes availabe from <a class="externalLink" href="http://jdr0887.github.io/jrlm">jLRM</a>, one can
      programmatically construct a workflow that can be exported into
      a HTCondor queue.</p>

      
<div class="section">
<h3>Lifecycle<a name="Lifecycle"></a></h3>
	
<p>Execution of a Workflow in MaPSeq is comprised of 5 lifecycle events:
	</p>
<ul>
	  
<li>init</li>
	  
<li>validate</li>
	  
<li>preRun</li>
	  
<li>call</li>
	  
<li>postRun</li>
	</ul>
	
      </div>

      
<div class="section">
<h3>Creating a Workflow<a name="Creating_a_Workflow"></a></h3>
	
<p>Creating a Workflow requires creating a new class that
	extends edu.unc.mapseq.workflow.impl.AbstractWorkflow,
	implements the &quot;createGraph&quot;, &quot;getVersion&quot;, and &quot;getName&quot;
	routines.  The &quot;createGraph&quot; method returns a
	org.jgrapht.Graph&lt;CondorJob, CondorJobEdge&gt; instance.
	For the high-throughput sequencing efforts, there is a
	edu.unc.mapseq.workflow.impl.AbstractSampleWorkflow that has
	some additional logic to aggregate Flowcell instances &amp;
	selected Sample instances into one Set.</p>
	

<div>
<pre>
public class NCGenesAlignmentWorkflow extends AbstractSampleWorkflow {
  @Override
  public String getName() {
    return NCGenesAlignmentWorkflow.class.getSimpleName().replace(&quot;Workflow&quot;, &quot;&quot;);
  }

  @Override
  public String getVersion() {
    ResourceBundle bundle = ResourceBundle.getBundle(&quot;edu/unc/mapseq/workflow/ncgenes/alignment/workflow&quot;);
    String version = bundle.getString(&quot;version&quot;);
    return StringUtils.isNotEmpty(version) ? version : &quot;0.0.1-SNAPSHOT&quot;;
  }

  @Override
  public Graph&lt;CondorJob, CondorJobEdge&gt; createGraph() throws WorkflowException {
    logger.debug(&quot;ENTERING createGraph()&quot;);
    DirectedGraph&lt;CondorJob, CondorJobEdge&gt; graph = new DefaultDirectedGraph&lt;CondorJob, CondorJobEdge&gt;(CondorJobEdge.class);
    return graph;
  }
}
</pre></div>
      </div>

      
<div class="section">
<h3>Adding modules to a Graph<a name="Adding_modules_to_a_Graph"></a></h3>
	
<p>Above we learned to create an empty Workflow.  Let's start
	adding CondorJob instances to it.  Once we have a Sample
	instance we can use, we will want reference the Module we
	would like to have executed on a compute element.  </p>

<div>
<pre>
CondorJobBuilder builder = WorkflowJobFactory.createJob(++count, BWAAlignCLI.class, attempt, sample)
        .siteName(siteName).numberOfProcessors(4);
File saiR1OutFile = new File(outputDirectory, r1FastqRootName + &quot;.sai&quot;);
builder.addArgument(BWAAlignCLI.THREADS, &quot;4&quot;)
        .addArgument(BWAAlignCLI.FASTQ, r1FastqFile.getAbsolutePath())
        .addArgument(BWAAlignCLI.FASTADB, referenceSequence)
        .addArgument(BWAAlignCLI.OUTFILE, saiR1OutFile.getAbsolutePath());
CondorJob bwaAlignR1Job = builder.build();
graph.addVertex(bwaAlignR1Job);


builder = WorkflowJobFactory.createJob(++count, BWAAlignCLI.class, attempt, sample)
        .siteName(siteName).numberOfProcessors(4);
File saiR2OutFile = new File(outputDirectory, r2FastqRootName + &quot;.sai&quot;);
builder.addArgument(BWAAlignCLI.THREADS, &quot;4&quot;)
        .addArgument(BWAAlignCLI.FASTQ, r2FastqFile.getAbsolutePath())
        .addArgument(BWAAlignCLI.FASTADB, referenceSequence)
        .addArgument(BWAAlignCLI.OUTFILE, saiR2OutFile.getAbsolutePath());
CondorJob bwaAlignR2Job = builder.build();
graph.addVertex(bwaAlignR2Job);
graph.addEdge(fastQCR2Job, bwaAlignR2Job);


builder = WorkflowJobFactory.createJob(++count, BWASAMPairedEndCLI.class, attempt, sample)
        .siteName(siteName);
File bwaSAMPairedEndOutFile = new File(outputDirectory, fastqLaneRootName + &quot;.sam&quot;);
builder.addArgument(BWASAMPairedEndCLI.FASTADB, referenceSequence)
        .addArgument(BWASAMPairedEndCLI.FASTQ1, r1FastqFile.getAbsolutePath())
        .addArgument(BWASAMPairedEndCLI.FASTQ2, r2FastqFile.getAbsolutePath())
        .addArgument(BWASAMPairedEndCLI.SAI1, saiR1OutFile.getAbsolutePath())
        .addArgument(BWASAMPairedEndCLI.SAI2, saiR2OutFile.getAbsolutePath())
        .addArgument(BWASAMPairedEndCLI.OUTFILE, bwaSAMPairedEndOutFile.getAbsolutePath());
CondorJob bwaSAMPairedEndJob = builder.build();
graph.addVertex(bwaSAMPairedEndJob);
graph.addEdge(bwaAlignR1Job, bwaSAMPairedEndJob);
graph.addEdge(bwaAlignR2Job, bwaSAMPairedEndJob);
</pre></div>

        
<p>Note how the graph binds together the CondorJob instances
        by adding edges from one job to another.  These edges are
        instrumental in instructing HTCondor to execute the Workflow
        jobs sequentially.  Here is the full dot export of these jobs from the
	NCGenesAlignment workflow:</p>

	<img src="../images/NCGenesAlignmentWorkflow.png" alt="" />

      </div>
    </div>
  

                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2014
                        <a href="http://www.unc.edu/">UNC</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
